<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Campeggio Santa Margherita</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container py-5">

    <div class="text-center mb-4">
        <img src="/static/logo.jpeg" alt="Logo" class="logo" style="max-width: 120px;">
        <div class="mt-2 fw-bold fs-4 text-uppercase">Campeggio Santa Margherita</div>
    </div>

    <div class="card p-4 mb-4">
        <h5>üìÇ Carica file "disponibile.xlsx"</h5>
        <form id="form-disponibile" enctype="multipart/form-data">
            <input class="form-control mb-2" type="file" name="file" accept=".xlsx" required>
            <button type="submit" class="btn btn-primary">Carica Disponibile</button>
        </form>
    </div>

    <div class="card p-4 mb-4">
        <h5>üìÑ Aggiorna file "dimensione.xlsx"</h5>
        <form id="form-dimensione" enctype="multipart/form-data">
            <input class="form-control mb-2" type="file" name="file" accept=".xlsx" required>
            <button type="submit" class="btn btn-warning">Aggiorna Dimensione</button>
        </form>
    </div>

    <div class="card p-4 mb-4">
        <h5>üîç Ricerca disponibilit√†</h5>
        <button id="btn-cerca" class="btn btn-success">Cerca</button>
    </div>

    <div id="message" class="mt-3"></div>

    <div id="risultati" class="mt-4"></div>

    <script>
        async function uploadFile(formId, endpoint) {
            const form = document.getElementById(formId);
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(form);
                const response = await fetch(endpoint, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                const messageDiv = document.getElementById('message');
                messageDiv.innerHTML = `<div class="alert ${result.success ? 'alert-success' : 'alert-danger'}">${result.message}</div>`;
            });
        }

        function formatDate(input) {
            const date = new Date(input);
            if (isNaN(date)) return input;
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = String(date.getFullYear()).slice(-2);
            return `${day}/${month}/${year}`;
        }

        async function cercaDisponibilita() {
            const response = await fetch('/cerca', {
                method: 'POST'
            });
            const dati = await response.json();
            const risultatiDiv = document.getElementById('risultati');

            if (dati.length === 0) {
                risultatiDiv.innerHTML = '<div class="alert alert-warning">Nessun dato disponibile o file mancanti.</div>';
                return;
            }

            let html = '<table class="table table-striped"><thead><tr><th>Risorsa</th><th>Disponibile</th><th>Dimensione</th></tr></thead><tbody>';
            dati.forEach(riga => {
                const risorsa = riga.risorsa.toString().padStart(4, '0').slice(-4); // 4 caratteri
                const disponibile = formatDate(riga.disponibile);
                const dimensione = parseFloat(riga.dimensione).toFixed(2);
                html += `<tr><td>${risorsa}</td><td>${disponibile}</td><td>${dimensione}</td></tr>`;
            });
            html += '</tbody></table>';

            risultatiDiv.innerHTML = html;
        }

        uploadFile('form-disponibile', '/upload_disponibile');
        uploadFile('form-dimensione', '/upload_dimensione');
        document.getElementById('btn-cerca').addEventListener('click', cercaDisponibilita);
    </script>

</body>
</html>